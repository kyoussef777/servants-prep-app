// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("SP_DATABASE_URL")
  directUrl = env("SP_DATABASE_URL_UNPOOLED")
}

enum UserRole {
  SUPER_ADMIN
  PRIEST
  SERVANT_PREP
  MENTOR
  STUDENT
}

enum YearLevel {
  YEAR_1
  YEAR_2
}

enum EnrollmentStatus {
  ACTIVE
  GRADUATED
  WITHDRAWN
}

enum ExamSectionType {
  BIBLE_STUDIES
  DOGMA
  COMPARATIVE_THEOLOGY
  RITUAL_THEOLOGY_SACRAMENTS
  CHURCH_HISTORY_COPTIC_HERITAGE
  SPIRITUALITY_OF_SERVANT
  PSYCHOLOGY_METHODOLOGY
  MISCELLANEOUS
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EXCUSED
}

enum LessonStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
}

enum ExamYearLevel {
  YEAR_1
  YEAR_2
  BOTH
}

enum NoteSubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SundaySchoolGrade {
  PRE_K
  KINDERGARTEN
  GRADE_1
  GRADE_2
  GRADE_3
  GRADE_4
  GRADE_5
  GRADE_6_PLUS
}

enum SundaySchoolLogStatus {
  VERIFIED
  MANUAL
  EXCUSED
  REJECTED
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum StudentGrade {
  GRADE_9
  GRADE_10
  GRADE_11
  GRADE_12
  COLLEGE_FRESHMAN
  COLLEGE_SOPHOMORE
  COLLEGE_JUNIOR
  COLLEGE_SENIOR
  POST_COLLEGE
  OTHER
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  name               String
  password           String
  role               UserRole
  phone              String?
  mustChangePassword Boolean  @default(true)
  isDisabled         Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  enrollments           StudentEnrollment[] @relation("StudentEnrollments")
  mentoredStudents      StudentEnrollment[] @relation("MentorServant")
  attendanceRecords     AttendanceRecord[]
  attendanceRecordedBy  AttendanceRecord[]  @relation("RecordedBy")
  examScores            ExamScore[]
  examScoresGradedBy    ExamScore[]         @relation("GradedBy")
  lessonsCreated        Lesson[]            @relation("CreatedBy")
  studentNotes          StudentNote[]       @relation("StudentNotes")
  authoredNotes         StudentNote[]       @relation("AuthoredNotes")

  // Async notes relations
  noteSubmissions           AsyncNoteSubmission[] @relation("StudentNoteSubmissions")
  reviewedNoteSubmissions   AsyncNoteSubmission[] @relation("ReviewedNoteSubmissions")
  asyncApprovedEnrollments  StudentEnrollment[]   @relation("AsyncApprovedBy")

  // Sunday School relations
  sundaySchoolAssignments  SundaySchoolAssignment[] @relation("SundaySchoolAssignments")
  assignedSundaySchool     SundaySchoolAssignment[] @relation("AssignedSundaySchool")
  generatedCodes           SundaySchoolCode[]       @relation("GeneratedCodes")
  markedSundaySchoolLogs   SundaySchoolLog[]        @relation("MarkedSundaySchoolLogs")

  // Registration relations
  createdInviteCodes        InviteCode[]             @relation("InviteCodeCreator")
  reviewedRegistrations     RegistrationSubmission[] @relation("RegistrationReviewer")
  createdFromRegistration   RegistrationSubmission[] @relation("RegistrationCreatedUser")

  @@index([email])
  @@index([role])
}

model AcademicYear {
  id        String   @id @default(cuid())
  name      String   @unique
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lessons                  Lesson[]
  exams                    Exam[]
  enrollments              StudentEnrollment[]      @relation("EnrollmentYear")
  graduatedEnrollments     StudentEnrollment[]      @relation("GraduationYear")
  sundaySchoolAssignments  SundaySchoolAssignment[]

  @@index([isActive])
}

model StudentEnrollment {
  id                      String             @id @default(cuid())
  studentId               String             @unique
  academicYearId          String?            // The academic year this enrollment started in
  graduatedAcademicYearId String?            // The academic year the student graduated in (if graduated)
  yearLevel               YearLevel
  mentorId                String?
  mentorName              String?
  mentorPhone             String?
  fatherOfConfessionId    String?            // Reference to FatherOfConfession (not a User)
  isActive                Boolean            @default(true)
  status                  EnrollmentStatus   @default(ACTIVE)
  notes                   String?            @db.Text
  enrolledAt              DateTime           @default(now())
  graduatedAt             DateTime?          // When the student graduated
  graduationNote          String?            @db.Text  // Required if graduating without meeting requirements (exception)
  updatedAt               DateTime           @updatedAt @default(now())

  // Async student fields
  isAsyncStudent          Boolean            @default(false)
  asyncApprovedAt         DateTime?
  asyncApprovedBy         String?
  asyncReason             String?            @db.Text

  // Relations
  student               User                 @relation("StudentEnrollments", fields: [studentId], references: [id], onDelete: Cascade)
  mentor                User?                @relation("MentorServant", fields: [mentorId], references: [id])
  academicYear          AcademicYear?        @relation("EnrollmentYear", fields: [academicYearId], references: [id])
  graduatedAcademicYear AcademicYear?        @relation("GraduationYear", fields: [graduatedAcademicYearId], references: [id])
  fatherOfConfession    FatherOfConfession?  @relation(fields: [fatherOfConfessionId], references: [id], onDelete: SetNull)
  asyncApprover         User?                @relation("AsyncApprovedBy", fields: [asyncApprovedBy], references: [id], onDelete: SetNull)

  @@index([studentId])
  @@index([mentorId])
  @@index([isActive])
  @@index([status])
  @@index([academicYearId])
  @@index([graduatedAcademicYearId])
  @@index([fatherOfConfessionId])
  @@index([mentorId, isActive]) // Compound index for mentor filtering with active status
  @@index([mentorId, status]) // Compound index for mentor filtering with enrollment status
  @@index([isAsyncStudent])
}

model ExamSection {
  id                  String          @id @default(cuid())
  name                ExamSectionType @unique
  displayName         String
  passingScore        Int             @default(60)
  averageRequirement  Int             @default(75)

  // Relations
  lessons Lesson[]
  exams   Exam[]
}

model Lesson {
  id                 String       @id @default(cuid())
  academicYearId     String
  examSectionId      String
  title              String
  subtitle           String?
  description        String?      @db.Text
  speaker            String?
  scheduledDate      DateTime
  status             LessonStatus @default(SCHEDULED)
  cancellationReason String?      @db.Text
  lessonNumber       Int
  isExamDay          Boolean      @default(false)  // If true, attendance doesn't count toward percentage
  createdBy          String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  // Relations
  academicYear         AcademicYear          @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  examSection          ExamSection           @relation(fields: [examSectionId], references: [id])
  creator              User?                 @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  attendanceRecords    AttendanceRecord[]
  resources            LessonResource[]
  asyncNoteSubmissions AsyncNoteSubmission[]

  @@unique([academicYearId, lessonNumber])
  @@index([academicYearId])
  @@index([examSectionId])
  @@index([scheduledDate])
  @@index([status])
}

model LessonResource {
  id        String   @id @default(cuid())
  lessonId  String
  title     String
  url       String
  type      String?
  createdAt DateTime @default(now())

  // Relations
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

model AttendanceRecord {
  id         String           @id @default(cuid())
  lessonId   String
  studentId  String
  status     AttendanceStatus
  arrivedAt  DateTime?
  notes      String?          @db.Text
  recordedBy String?
  recordedAt DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  // Relations
  lesson               Lesson               @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student              User                 @relation(fields: [studentId], references: [id], onDelete: Cascade)
  recorder             User?                @relation("RecordedBy", fields: [recordedBy], references: [id], onDelete: SetNull)
  asyncNoteSubmission  AsyncNoteSubmission?

  @@unique([lessonId, studentId])
  @@index([lessonId])
  @@index([studentId])
  @@index([status])
  @@index([studentId, lessonId]) // Compound index for student+lesson queries
}

model Exam {
  id             String        @id @default(cuid())
  academicYearId String
  examSectionId  String
  yearLevel      ExamYearLevel
  examDate       DateTime
  totalPoints    Int           @default(100)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  examSection  ExamSection  @relation(fields: [examSectionId], references: [id])
  scores       ExamScore[]

  @@index([academicYearId])
  @@index([examSectionId])
  @@index([yearLevel])
}

model ExamScore {
  id         String   @id @default(cuid())
  examId     String
  studentId  String
  score      Float
  percentage Float
  notes      String?  @db.Text
  gradedBy   String?
  gradedAt   DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  exam    Exam  @relation(fields: [examId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  grader  User? @relation("GradedBy", fields: [gradedBy], references: [id], onDelete: SetNull)

  @@unique([examId, studentId])
  @@index([examId])
  @@index([studentId])
  @@index([studentId, examId]) // Compound index for student exam score lookups
}

model StudentNote {
  id        String   @id @default(cuid())
  studentId String
  authorId  String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  student User @relation("StudentNotes", fields: [studentId], references: [id], onDelete: Cascade)
  author  User @relation("AuthoredNotes", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([authorId])
  @@index([createdAt])
}

model FatherOfConfession {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  church    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  students StudentEnrollment[]

  @@index([isActive])
  @@index([name])
}

// ============================================
// ASYNC STUDENT MODELS
// ============================================

model AsyncNoteSubmission {
  id                 String               @id @default(cuid())
  studentId          String
  lessonId           String
  content            String               @db.Text
  status             NoteSubmissionStatus  @default(PENDING)
  submittedAt        DateTime             @default(now())
  reviewedBy         String?
  reviewedAt         DateTime?
  reviewFeedback     String?              @db.Text
  attendanceRecordId String?              @unique
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  // Relations
  student          User              @relation("StudentNoteSubmissions", fields: [studentId], references: [id], onDelete: Cascade)
  lesson           Lesson            @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  reviewer         User?             @relation("ReviewedNoteSubmissions", fields: [reviewedBy], references: [id], onDelete: SetNull)
  attendanceRecord AttendanceRecord? @relation(fields: [attendanceRecordId], references: [id], onDelete: SetNull)

  @@unique([studentId, lessonId])
  @@index([studentId])
  @@index([lessonId])
  @@index([status])
  @@index([submittedAt])
}

model SundaySchoolAssignment {
  id              String            @id @default(cuid())
  studentId       String
  grade           SundaySchoolGrade
  academicYearId  String
  yearLevel       YearLevel
  totalWeeks      Int               @default(6)
  startDate       DateTime
  isActive        Boolean           @default(true)
  assignedBy      String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  student      User              @relation("SundaySchoolAssignments", fields: [studentId], references: [id], onDelete: Cascade)
  academicYear AcademicYear      @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  assigner     User?             @relation("AssignedSundaySchool", fields: [assignedBy], references: [id], onDelete: SetNull)
  logs         SundaySchoolLog[]

  @@unique([studentId, academicYearId])
  @@index([studentId])
  @@index([academicYearId])
  @@index([grade])
  @@index([isActive])
}

model SundaySchoolCode {
  id           String            @id @default(cuid())
  code         String            @unique
  grade        SundaySchoolGrade
  weekOf       DateTime
  validUntil   DateTime
  generatedBy  String?
  generatedAt  DateTime          @default(now())
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())

  // Relations
  generator User?             @relation("GeneratedCodes", fields: [generatedBy], references: [id], onDelete: SetNull)
  usages    SundaySchoolLog[]

  @@unique([grade, weekOf])
  @@index([code])
  @@index([grade])
  @@index([weekOf])
  @@index([validUntil])
}

model SundaySchoolLog {
  id            String                @id @default(cuid())
  assignmentId  String
  weekNumber    Int
  weekOf        DateTime
  status        SundaySchoolLogStatus
  codeId        String?
  markedBy      String?
  notes         String?               @db.Text
  studentNotes  String?               @db.Text
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  // Relations
  assignment SundaySchoolAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  code       SundaySchoolCode?      @relation(fields: [codeId], references: [id], onDelete: SetNull)
  marker     User?                  @relation("MarkedSundaySchoolLogs", fields: [markedBy], references: [id], onDelete: SetNull)

  @@unique([assignmentId, weekNumber])
  @@index([assignmentId])
  @@index([status])
  @@index([weekOf])
}

// ============================================
// REGISTRATION SYSTEM MODELS
// ============================================

model SystemSettings {
  id                    String   @id @default("default")
  registrationEnabled   Boolean  @default(true)
  updatedAt             DateTime @updatedAt
}

model InviteCode {
  id          String    @id @default(cuid())
  code        String    @unique
  label       String?                     // Human-readable label, e.g. "Fall 2026 Registration"
  maxUses     Int       @default(1)       // 0 = unlimited
  usageCount  Int       @default(0)
  expiresAt   DateTime?                   // null = never expires
  isActive    Boolean   @default(true)
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  creator       User                    @relation("InviteCodeCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  registrations RegistrationSubmission[]

  @@index([code])
  @@index([isActive])
  @@index([expiresAt])
}

model RegistrationSubmission {
  id                      String             @id @default(cuid())
  inviteCodeId            String
  status                  RegistrationStatus @default(PENDING)

  // Applicant info
  email                   String
  fullName                String
  dateOfBirth             DateTime
  phone                   String
  fatherOfConfessionName  String
  previouslyServed        Boolean
  currentlyServing        Boolean
  previouslyAttendedPrep  Boolean
  previousPrepLocation    String?            // Only if previouslyAttendedPrep = true
  grade                   StudentGrade

  // Approval form upload
  approvalFormUrl         String             // Vercel Blob URL
  approvalFormFilename    String             // Original filename for display

  // Mentor info
  mentorName              String
  mentorPhone             String
  mentorEmail             String

  // Review fields
  reviewedBy              String?
  reviewedAt              DateTime?
  reviewNote              String?            @db.Text  // Admin note (reason for rejection, etc.)
  createdUserId           String?            // User.id created upon approval

  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt

  // Relations
  inviteCode    InviteCode  @relation(fields: [inviteCodeId], references: [id])
  reviewer      User?       @relation("RegistrationReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)
  createdUser   User?       @relation("RegistrationCreatedUser", fields: [createdUserId], references: [id], onDelete: SetNull)

  @@index([inviteCodeId])
  @@index([status])
  @@index([email])
  @@index([createdAt])
}
